<link rel="icon" type="image/png" href="/image/logo.png">
<section th:fragment="productsByCategory" class="py-16 bg-white">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center space-x-2 text-sm text-gray-600">
        <a href="/" class="hover:text-blue-600 transition duration-300">
          <i class="fas fa-home"></i> Trang Chủ
        </a>
        <i class="fas fa-chevron-right text-gray-400"></i>
        <span class="text-gray-800 font-medium" th:text="${currentCategory.nameCategory}">Tên Category</span>
      </div>
      <a href="/homepage" class="flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300">
        <i class="fas fa-arrow-left mr-2"></i>
        Quay lại danh mục
      </a>
    </div>

    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold text-gray-800 mb-2" th:text="${currentCategory.nameCategory}">Tên Category</h2>
      <p class="text-gray-500 max-w-2xl mx-auto" th:text="${currentCategory.description}">Mô tả category</p>
      <div class="mt-4">
        <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
          <i class="fas fa-box mr-2"></i>
          <span th:text="${#lists.size(products)}">0</span> sản phẩm
        </span>
      </div>
    </div>

    <!-- User data for JavaScript -->
    <div id="user-data"
         th:data-user-id="${session.userid}"
         th:data-is-logged-in="${session.userid != null}"
         style="display: none;">
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" th:if="${not #lists.isEmpty(products)}">
      <div th:each="product, iterStat : ${products}"
           th:attr="data-index=${iterStat.index}" class="product-card bg-white rounded-xl shadow-md overflow-hidden group hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
        <div class="relative overflow-hidden bg-gray-100">
          <img th:if="${not #lists.isEmpty(product.imagesBase64)}"
               th:src="'data:image/jpeg;base64,' + ${product.imagesBase64[0]}"
               th:alt="${product.nameProduct}"
               class="w-full h-48 object-cover group-hover:scale-105 transition duration-300">
          <div th:if="${#lists.isEmpty(product.imagesBase64)}"
               class="w-full h-48 bg-gray-200 flex items-center justify-center">
            <i class="fas fa-image text-gray-400 text-3xl"></i>
          </div>

          <div class="absolute top-3 left-3">
            <span th:if="${product.statusCode == 'ACTIVE'}"
                  class="px-2 py-1 bg-green-500 text-white text-xs rounded-full">
                Còn hàng
            </span>
            <span th:if="${product.statusCode == 'OUT_OF_STOCK'}"
                  class="px-2 py-1 bg-red-500 text-white text-xs rounded-full">
                Hết hàng
            </span>
            <span th:if="${product.statusCode == 'DISCONTINUED'}"
                  class="px-2 py-1 bg-gray-500 text-white text-xs rounded-full">
                Ngừng bán
            </span>
          </div>

          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
          </div>
        </div>

        <div class="p-4">
          <h3 class="font-semibold text-gray-800 mb-2 line-clamp-1 group-hover:text-blue-600 transition duration-300"
              th:text="${product.nameProduct}">Tên sản phẩm</h3>

          <p class="text-sm text-gray-600 mb-3 line-clamp-1"
             th:text="${product.description}">Mô tả sản phẩm</p>

          <div class="flex items-center justify-between mb-3">
            <div class="text-lg font-bold text-blue-600"
                 th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</div>
            <div class="text-sm text-gray-500">
              <i class="fas fa-box mr-1"></i>
              <span th:text="${product.quantity}">0</span> có sẵn
            </div>
          </div>

          <div class="flex items-center mb-3">
            <div class="flex text-yellow-400 text-sm">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star-half-alt"></i>
            </div>
            <span class="text-sm text-gray-500 ml-2">(4.5) 128 đánh giá</span>
          </div>

          <div class="flex space-x-2">
            <a th:href="'/user/product/' + ${product.id}"
               class="flex-1 py-2 px-4 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700 transition duration-300">
              Xem
            </a>
            <!-- Heart button với trạng thái ban đầu đúng -->
            <button class="add-to-favorite-btn p-2 rounded-lg transition duration-300"
                    th:data-product-id="${product.id}"
                    th:classappend="${favoriteProductIds != null and favoriteProductIds.contains(product.id)} ? 'bg-red-500 text-white' : 'bg-red-100 text-red-500 hover:bg-red-200'">
              <i th:classappend="${favoriteProductIds != null and favoriteProductIds.contains(product.id)} ? 'fas fa-heart' : 'far fa-heart'"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div th:if="${#lists.isEmpty(products)}" class="text-center py-16">
      <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-600 mb-2">Chưa có sản phẩm</h3>
      <p class="text-gray-500">Danh mục này hiện tại chưa có sản phẩm nào. Vui lòng quay lại sau!</p>
      <a href="/" class="inline-flex items-center mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
        <i class="fas fa-arrow-left mr-2"></i>
        Xem danh mục khác
      </a>
    </div>

    <div id="pagination" class="flex items-center justify-center mt-8 space-x-2"></div>

  </div>

  <div id="toast-notification" class="fixed top-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 z-50">
    <p id="toast-message"></p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- Lấy data user ---
      const userData = document.getElementById('user-data');
      const currentUserId = userData ? userData.dataset.userId : null;
      const isLoggedIn = userData ? (userData.dataset.isLoggedIn === 'true') : false;

      // --- Grid & cards & pagination container ---
      console.log("Pagination script loaded");
      const grid = document.querySelector('.grid');
      const paginationContainer = document.getElementById('pagination');
      const cards = grid ? Array.from(grid.querySelectorAll('[data-index]')) : [];
      console.log("Grid found:", !!grid);
      console.log("Cards count:", cards.length);
      console.log("Total pages:", Math.ceil(cards.length / 8));

      // --- HANDLE FAVORITE BUTTONS ---
      const favoriteButtons = document.querySelectorAll('.add-to-favorite-btn');
      favoriteButtons.forEach((button) => {
        const productId = parseInt(button.dataset.productId);
        button.addEventListener('click', function (event) {
          event.preventDefault();

          if (!isLoggedIn || !currentUserId || currentUserId === 'null') {
            showToast('Vui lòng đăng nhập để thêm sản phẩm yêu thích!', 'error');
            setTimeout(() => { window.location.href = '/account/login'; }, 1000);
            return;
          }

          const icon = this.querySelector('i');
          const favoriteRequest = { userId: parseInt(currentUserId), productId: productId };

          button.disabled = true;
          if (icon) { icon.classList.add('fa-spinner', 'fa-spin'); icon.classList.remove('fa-heart'); }

          fetch('/favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(favoriteRequest)
          })
                  .then(response => {
                    if (!response.ok) return response.json().then(err => { throw err; });
                    return response.json();
                  })
                  .then(data => {
                    if (data.httpStatus === 'OK') {
                      showToast(data.message || 'Đã thêm vào yêu thích', 'success');
                      if (icon) {
                        icon.classList.remove('far', 'fa-spinner', 'fa-spin');
                        icon.classList.add('fas', 'fa-heart');
                      }
                      button.classList.remove('bg-red-100', 'text-red-500', 'hover:bg-red-200');
                      button.classList.add('bg-red-500', 'text-white');
                    } else {
                      showToast(data.message || 'Có lỗi xảy ra', 'error');
                      if (icon) { icon.classList.remove('fa-spinner', 'fa-spin'); icon.classList.add('far', 'fa-heart'); }
                    }
                  })
                  .catch(error => {
                    console.error('Fetch error:', error);
                    showToast(error.message || 'Bạn đã yêu thích rồi!', 'error');
                    if (icon) { icon.classList.remove('fa-spinner', 'fa-spin'); icon.classList.add('far', 'fa-heart'); }
                  })
                  .finally(() => { button.disabled = false; });
        });
      });

      // --- TOAST function ---
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        if (!toast || !toastMessage) return;
        toastMessage.textContent = message;
        toast.classList.remove('bg-gray-800', 'bg-green-600', 'bg-red-600');
        if (type === 'success') toast.classList.add('bg-green-600');
        else if (type === 'error') toast.classList.add('bg-red-600');
        else toast.classList.add('bg-gray-800');
        toast.classList.remove('opacity-0');
        setTimeout(() => toast.classList.add('opacity-0'), 3000);
      }

      // --- PAGINATION ---
      const itemsPerPage = 8;
      const totalPages = cards.length ? Math.ceil(cards.length / itemsPerPage) : 0;
      let currentPage = 1;

      if (grid && cards.length > 0 && paginationContainer) {
        function buildPagination() {
          paginationContainer.innerHTML = '';
          if (totalPages <= 1) return;

          const prevBtn = document.createElement('button');
          prevBtn.className = 'px-3 py-1 rounded-md border hover:bg-gray-100';
          prevBtn.textContent = 'Prev';
          prevBtn.disabled = currentPage === 1;
          prevBtn.addEventListener('click', () => showPage(currentPage - 1));
          paginationContainer.appendChild(prevBtn);

          const maxButtons = 7;
          let start = Math.max(1, currentPage - 2);
          let end = Math.min(totalPages, start + maxButtons - 1);
          if (end - start + 1 < maxButtons) start = Math.max(1, end - maxButtons + 1);

          for (let i = start; i <= end; i++) {
            const btn = document.createElement('button');
            btn.className = 'px-3 py-1 rounded-md border hover:bg-gray-100';
            if (i === currentPage) btn.classList.add('bg-blue-600', 'text-white', 'border-transparent');
            else btn.classList.add('bg-white', 'text-gray-700');
            btn.textContent = i;
            btn.addEventListener('click', () => showPage(i));
            paginationContainer.appendChild(btn);
          }

          const nextBtn = document.createElement('button');
          nextBtn.className = 'px-3 py-1 rounded-md border hover:bg-gray-100';
          nextBtn.textContent = 'Next';
          nextBtn.disabled = currentPage === totalPages;
          nextBtn.addEventListener('click', () => showPage(currentPage + 1));
          paginationContainer.appendChild(nextBtn);
        }

        function showPage(pageNumber) {
          if (pageNumber < 1) pageNumber = 1;
          if (pageNumber > totalPages) pageNumber = totalPages;
          currentPage = pageNumber;
          const start = (currentPage - 1) * itemsPerPage;
          const end = start + itemsPerPage;

          cards.forEach((card, idx) => {
            const i = parseInt(card.getAttribute('data-index') || idx, 10);
            card.style.display = (i >= start && i < end) ? '' : 'none';
          });

          buildPagination();

          // Cuộn mượt về grid
          const topOffset = Math.max(grid.getBoundingClientRect().top + window.scrollY - 80, 0);
          window.scrollTo({ top: topOffset, behavior: 'smooth' });
        }

        // Khởi tạo phân trang
        showPage(1);
      } else {
        // Ẩn pagination nếu không có sản phẩm
        if (paginationContainer) paginationContainer.style.display = 'none';
      }
    });
  </script>
</section>