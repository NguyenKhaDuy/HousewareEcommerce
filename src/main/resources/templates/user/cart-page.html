<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/image/logo.png">
    <title>Giỏ hàng của bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
<div id="current-user" th:if="${session.userid}" th:data-user-id="${session.userid}" style="display:none;"></div>

<!-- Header -->
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-4">
            <a href="#" class="flex items-center space-x-2 text-xl font-bold text-gray-800">
                <img src="/image/logo.png" alt="Homeware Logo" class="h-12 w-auto">
                <span>Homeware <span class="text-blue-600">Pro</span></span>
            </a>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="/homepage" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Trang Chủ</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Sản Phẩm</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Khuyến Mãi</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Về Chúng Tôi</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Liên Hệ</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button class="text-gray-600 hover:text-blue-600">
                    <i class="fas fa-search fa-lg"></i>
                </button>
                <a href="#" class="relative text-gray-600 hover:text-blue-600">
                    <i class="fas fa-heart fa-lg"></i>
                </a>
                <a href="/view/cart" class="relative text-gray-600 hover:text-blue-600">
                    <i class="fas fa-shopping-cart fa-lg"></i>
                    <span class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </a>
                <div th:if="${session.username}" class="hidden sm:flex items-center space-x-2">
                    <span class="font-medium text-gray-700">
                        Chào, <span th:text="${session.username}">Tên người dùng</span>
                    </span>
                    <a th:href="@{/account/logout}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                        Đăng xuất
                    </a>
                </div>
                <a th:unless="${session.username}" th:href="@{/account/login}" class="hidden sm:block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                    Đăng nhập
                </a>
                <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-blue-600">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
        <a th:href="@{/user/category/getAll}" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Trang Chủ</a>
        <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Sản Phẩm</a>
        <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Khuyến Mãi</a>
        <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Liên Hệ</a>
        <div th:if="${session.username}" class="flex items-center justify-between p-4 border-t">
            <span class="font-medium text-gray-700">
                Chào, <span th:text="${session.username}">Tên người dùng</span>
            </span>
            <a th:href="@{/account/logout}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                Đăng xuất
            </a>
        </div>
        <a th:unless="${session.username}" th:href="@{/account/login}" class="block p-4 text-center bg-blue-600 text-white hover:bg-blue-700 transition duration-300">
            Đăng nhập
        </a>
    </div>
</header>

<!-- Main Content -->
<main class="py-12">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Giỏ hàng của bạn</h1>

        <!-- Check if cart is not null and not empty -->
        <div th:if="${cartDto != null and not #lists.isEmpty(cartDto.cartItemDTOS)}" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cart Items List -->
            <div id="cart-items-container" class="lg:col-span-2 space-y-4">

                <!-- Select all control -->
                <div class="flex items-center justify-between bg-white rounded-lg shadow-md p-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="select-all" class="mr-3 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="font-medium">Chọn tất cả</span>
                    </label>
                    <span class="text-sm text-gray-500">Chọn sản phẩm để thanh toán</span>
                </div>

                <div th:each="item : ${cartDto.cartItemDTOS}"
                     th:data-product-id="${item.productId}"
                     th:data-unit-price="${item.quantity != null and item.quantity > 0 ? (item.subTotal / item.quantity) : 0}"
                     th:data-current-subtotal="${item.subTotal}"
                     class="flex items-center bg-white rounded-lg shadow-md p-6 space-x-4 cart-item">
                    <!-- Checkbox -->
                    <div class="flex-shrink-0">
                        <input type="checkbox" class="select-item h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" th:id="'select-'+${item.productId}" th:data-product-id="${item.productId}">
                    </div>

                    <!-- Product Details -->
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2" th:text="${item.productName}">Tên sản phẩm</h3>
                        <p class="text-blue-600 font-bold text-xl mb-3 sub-total" th:text="${#numbers.formatDecimal(item.subTotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                    </div>

                    <!-- Quantity Controls -->
                    <div class="flex items-center space-x-3">
                        <button onclick="updateQuantity(this, -1)"
                                th:data-product-id="${item.productId}"
                                th:data-user-id="${session.userid}"
                                class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition-colors duration-200">
                            <i class="fas fa-minus text-gray-600 text-sm"></i>
                        </button>
                        <span class="font-semibold text-lg min-w-[2rem] text-center product-quantity" th:text="${item.quantity}">1</span>
                        <button onclick="updateQuantity(this, 1)"
                                th:data-product-id="${item.productId}"
                                th:data-user-id="${session.userid}"
                                class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition-colors duration-200">
                            <i class="fas fa-plus text-gray-600 text-sm"></i>
                        </button>
                    </div>

                    <!-- Delete Button -->
                    <div class="flex items-center">
                        <button onclick="deleteItem(this)"
                                th:data-product-id="${item.productId}"
                                th:data-user-id="${session.userid}"
                                class="text-gray-500 hover:text-red-600 transition-colors duration-200 p-2">
                            <i class="fas fa-trash fa-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="bg-white rounded-lg shadow-md p-6 h-fit sticky top-24">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Tóm tắt đơn hàng</h2>

                <!-- Selected items list (client-side) -->
                <div id="selected-items-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    <!-- JS will render selected items here -->
                </div>

                <div class="flex justify-between items-center mb-4 border-t border-gray-200 pt-4">
                    <span class="text-gray-600 text-lg">Tổng các mục đã chọn:</span>
                    <span id="selected-total" class="font-semibold text-blue-600 text-xl">0 ₫</span>
                </div>
                <!-- Payment Method -->
                <div class="mb-4">
                    <label for="payment-method" class="block text-gray-600 mb-2">Phương thức thanh toán:</label>
                    <select id="payment-method" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="3">Thanh toán tiền mặt</option>
                        <option value="4">Thanh toán qua thẻ</option>
                        <option value="5">Chuyển khoản ngân hàng</option>
                        <option value="6">Ví điện tử</option>
                        <option value="7">Paypal</option>
                    </select>
                </div>

                <!-- Note -->
                <div class="mb-4">
                    <label for="order-note" class="block text-gray-600 mb-2">Ghi chú:</label>
                    <textarea id="order-note" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Thêm ghi chú cho đơn hàng..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="discount-code" class="block text-gray-600 mb-2">Mã giảm giá:</label>
                    <div class="flex">
                        <input type="text" id="discount-code" class="w-full p-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Nhập mã giảm giá">
                        <button id="apply-discount-btn" class="bg-gray-600 text-white px-4 rounded-r-lg hover:bg-gray-700 transition duration-300">Áp dụng</button>
                    </div>
                </div>

                <button id="checkout-button" class="w-full mt-2 py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                    <i class="fas fa-shield-alt mr-2"></i>
                    <span id="checkout-button-text">Đặt hàng</span>
                    <i id="checkout-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </div>

        <!-- Empty Cart Message -->
        <div th:unless="${cartDto != null and not #lists.isEmpty(cartDto.cartItemDTOS)}" id="empty-cart-message" class="text-center py-16 bg-white rounded-lg shadow-md">
            <i class="fas fa-shopping-cart fa-5x text-gray-300 mb-4"></i>
            <p class="text-gray-600 text-lg mb-4">Giỏ hàng của bạn đang trống!</p>
            <a href="/static" class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i> Tiếp tục mua sắm
            </a>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-gray-800 text-white mt-16">
    <!-- ... (footer content remains the same) ... -->
</footer>

<!-- Global Message Modal -->
<div id="message-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 hidden modal-backdrop">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 text-center modal-content scale-95">
        <div id="modal-icon" class="mx-auto mb-4">
            <!-- Icon will be inserted here -->
        </div>
        <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-2"></h3>
        <p id="modal-message" class="text-gray-600 mb-6"></p>
        <button id="modal-close-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
            Đóng
        </button>
    </div>
</div>


<script>
    // --- UTILITY FUNCTIONS ---
    function formatCurrency(num) {
        if (num == null || isNaN(num)) return '0 ₫';
        return Number(Math.round(num)).toLocaleString('vi-VN') + ' ₫';
    }

    function showModal(type, title, message) {
        const modal = document.getElementById('message-modal');
        const iconContainer = document.getElementById('modal-icon');
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');

        titleEl.textContent = title;
        messageEl.textContent = message;

        if (type === 'success') {
            iconContainer.innerHTML = `<i class="fas fa-check-circle fa-4x text-green-500"></i>`;
        } else {
            iconContainer.innerHTML = `<i class="fas fa-times-circle fa-4x text-red-500"></i>`;
        }

        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('.modal-backdrop').classList.remove('opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }, 10);
        setTimeout(() => {
            hideModal();
        }, 2000);
    }

    function hideModal() {
        const modal = document.getElementById('message-modal');

        setTimeout(() => modal.classList.add('hidden'), 300);
    }


    // --- UI UPDATE FUNCTIONS ---
    function updateSelectedSummary() {
        const list = document.getElementById('selected-items-list');
        if (!list) return;
        list.innerHTML = '';
        let total = 0;
        let selectedCount = 0;

        const cartItems = Array.from(document.querySelectorAll('.cart-item'));
        cartItems.forEach(item => {
            const checkbox = item.querySelector('.select-item');
            if (checkbox && checkbox.checked) {
                selectedCount++;
                const name = (item.querySelector('h3')?.textContent || '').trim();
                const quantity = parseInt(item.querySelector('.product-quantity')?.textContent) || 0;
                const subTotalText = item.querySelector('.sub-total')?.textContent || '';
                const itemSub = parseFloat(subTotalText.replace(/[^\d.-]/g, '')) || 0;
                total += itemSub;

                const row = document.createElement('div');
                row.className = 'flex justify-between items-center text-sm';
                row.innerHTML = `<span class="truncate mr-2">${name} <span class="text-gray-500">(x${quantity})</span></span><span class="font-medium text-gray-700">${formatCurrency(itemSub)}</span>`;
                list.appendChild(row);
            }
        });
        document.getElementById('selected-total').textContent = formatCurrency(total);

        // Update Select All checkbox state
        const allCheckboxes = Array.from(document.querySelectorAll('.select-item'));
        const checkedCheckboxes = Array.from(document.querySelectorAll('.select-item:checked'));
        const selectAll = document.getElementById('select-all');
        if (selectAll) {
            selectAll.checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
            selectAll.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
        }

        // Enable/disable checkout button
        const checkoutBtn = document.getElementById('checkout-button');
        if(checkoutBtn) {
            checkoutBtn.disabled = selectedCount === 0;
        }
    }


    // --- API CALL FUNCTIONS ---
    async function updateQuantity(button, change) {
        const cartItem = button.closest('.cart-item');
        const quantitySpan = cartItem.querySelector('.product-quantity');
        const subTotalElement = cartItem.querySelector('.sub-total');

        const productId = button.dataset.productId;
        const userId = document.getElementById('current-user')?.dataset.userId;
        const currentQuantity = parseInt(quantitySpan.textContent);
        const newQuantity = currentQuantity + change;

        if (newQuantity < 1) return;
        if (!userId) {
            showModal('error', 'Lỗi', 'Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.');
            return;
        }

        const apiUrl = change > 0 ? '/api/cart/add' : '/api/cart/remove';
        const cartRequest = {
            userId: parseInt(userId),
            productId: parseInt(productId),
            quantity: Math.abs(change), // API might expect positive delta
            subTotal: 0
        };

        try {
            button.disabled = true;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cartRequest)
            });
            const result = await response.json();
            if (response.ok) {
                quantitySpan.textContent = newQuantity;
                const unitPrice = parseFloat(cartItem.dataset.unitPrice) || 0;
                const newSub = unitPrice * newQuantity;
                subTotalElement.textContent = formatCurrency(newSub);
                cartItem.dataset.currentSubtotal = newSub;
                updateSelectedSummary();
            } else {
                showModal('error', 'Lỗi cập nhật', result.message || 'Không thể cập nhật số lượng sản phẩm.');
            }
        } catch (error) {
            console.error('Lỗi:', error);
            showModal('error', 'Lỗi kết nối', 'Không thể kết nối đến máy chủ. Vui lòng thử lại.');
        } finally {
            button.disabled = false;
        }
    }

    async function deleteItem(button) {
        const cartItem = button.closest('.cart-item');
        const productId = button.dataset.productId;
        const userId = document.getElementById('current-user')?.dataset.userId;

        if (!userId) {
            showModal('error', 'Lỗi', 'Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.');
            return;
        }

        if (!window.confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) return;

        const cartRequest = { userId: parseInt(userId), productId: parseInt(productId) };

        try {
            const response = await fetch('/api/cart/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cartRequest)
            });
            const result = await response.json();
            if (response.ok) {
                cartItem.style.transition = 'opacity 0.5s, transform 0.5s';
                cartItem.style.opacity = '0';
                cartItem.style.transform = 'translateX(-50px)';
                setTimeout(() => {
                    cartItem.remove();
                    updateSelectedSummary();
                    if (!document.querySelector('.cart-item')) {
                        document.querySelector('.lg\\:grid-cols-3')?.remove();
                        document.getElementById('empty-cart-message').style.display = 'block';
                    }
                }, 500);
            } else {
                showModal('error', 'Lỗi xóa sản phẩm', result.message || 'Không thể xóa sản phẩm.');
            }
        } catch (error) {
            console.error('Lỗi:', error);
            showModal('error', 'Lỗi kết nối', 'Không thể kết nối đến máy chủ. Vui lòng thử lại.');
        }
    }

    async function handleCheckout() {
        const checkoutBtn = document.getElementById('checkout-button');
        const btnText = document.getElementById('checkout-button-text');
        const spinner = document.getElementById('checkout-spinner');

        // 1. Gather data
        const userId = document.getElementById('current-user')?.dataset.userId;
        if (!userId) {
            showModal('error', 'Chưa đăng nhập', 'Vui lòng đăng nhập để tiếp tục đặt hàng.');
            return;
        }

        const selectedItems = Array.from(document.querySelectorAll('.select-item:checked'));
        if (selectedItems.length === 0) {
            showModal('error', 'Chưa chọn sản phẩm', 'Vui lòng chọn ít nhất một sản phẩm để đặt hàng.');
            return;
        }

        let totalPrice = 0;
        const ordersDetailsRequests = selectedItems.map(checkbox => {
            const itemElement = checkbox.closest('.cart-item');
            const subTotal = parseFloat(itemElement.dataset.currentSubtotal);
            totalPrice += subTotal;
            return {
                productId: parseInt(itemElement.dataset.productId),
                quality: parseInt(itemElement.querySelector('.product-quantity').textContent),
                priceQuotation: parseFloat(itemElement.dataset.unitPrice),
                totalAmount: subTotal
            };
        });

        const ordersRequest = {
            userId: parseInt(userId),
            statusId: 1, // Default status: Pending/Chờ xác nhận
            paymentMethodId: parseInt(document.getElementById('payment-method').value),
            // === UPDATED: Get discount code from input ===
            discoutCode: document.getElementById('discount-code').value.trim(),
            totalPrice: totalPrice,
            note: document.getElementById('order-note').value.trim(),
            ordersDetailsRequests: ordersDetailsRequests
        };

        // 2. Send API request
        try {
            checkoutBtn.disabled = true;
            btnText.textContent = 'Đang xử lý...';
            spinner.classList.remove('hidden');

            const response = await fetch('/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ordersRequest)
            });
            const result = await response.json();

            if (response.ok) {
                showModal('success', 'Đặt hàng thành công!', 'Cảm ơn bạn đã mua hàng. Chúng tôi sẽ xử lý đơn hàng của bạn sớm nhất.');
                // Redirect after a delay
                setTimeout(() => {
                    window.location.href = '/'; // Or to an order history page
                }, 3000);
            } else {
                showModal('error', 'Đặt hàng thất bại', result.message || 'Đã có lỗi xảy ra, vui lòng thử lại.');
            }

        } catch (error) {
            console.error('Checkout error:', error);
            showModal('error', 'Lỗi nghiêm trọng', 'Không thể kết nối đến máy chủ để đặt hàng.');
        } finally {
            checkoutBtn.disabled = false;
            btnText.textContent = 'Đặt hàng';
            spinner.classList.add('hidden');
        }
    }

    // --- EVENT BINDING ---
    function bindEvents() {
        document.querySelectorAll('.select-item').forEach(cb => {
            cb.addEventListener('change', updateSelectedSummary);
        });

        const selectAll = document.getElementById('select-all');
        if (selectAll) {
            selectAll.addEventListener('change', function () {
                document.querySelectorAll('.select-item').forEach(cb => {
                    cb.checked = this.checked;
                });
                updateSelectedSummary();
            });
        }

        document.getElementById('checkout-button')?.addEventListener('click', handleCheckout);
        document.getElementById('modal-close-button')?.addEventListener('click', hideModal);
        document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
            document.getElementById('mobile-menu')?.classList.toggle('hidden');
        });

        // === NEW: Event listener for apply discount button ===
        document.getElementById('apply-discount-btn')?.addEventListener('click', () => {
            const code = document.getElementById('discount-code').value.trim();
            if (code) {
                // For now, this is just a client-side confirmation.
                // A full implementation would require an API call to validate the code.
                showModal('success', 'Đã áp dụng', `Mã giảm giá "${code}" sẽ được áp dụng. Chi tiết sẽ được hiển thị sau khi xác nhận đơn hàng.`);
            } else {
                showModal('error', 'Lỗi', 'Vui lòng nhập mã giảm giá.');
            }
        });
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function () {
        bindEvents();
        updateSelectedSummary(); // Initial calculation
    });
</script>

</body>
</html>
