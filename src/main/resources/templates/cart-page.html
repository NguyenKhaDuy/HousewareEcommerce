<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng của bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-4">
            <a href="/" class="text-2xl font-bold text-gray-800">
                <i class="fas fa-home text-blue-600"></i>
                Gia Dụng <span class="text-blue-600">Pro</span>
            </a>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="/" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Trang Chủ</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Sản Phẩm</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Khuyến Mãi</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Về Chúng Tôi</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Liên Hệ</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button class="text-gray-600 hover:text-blue-600">
                    <i class="fas fa-search fa-lg"></i>
                </button>
                <a href="#" class="relative text-gray-600 hover:text-blue-600">
                    <i class="fas fa-heart fa-lg"></i>
                </a>
                <a href="/view/cart" class="relative text-gray-600 hover:text-blue-600">
                    <i class="fas fa-shopping-cart fa-lg"></i>
                    <span class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </a>
                <div th:if="${session.username}" class="hidden sm:flex items-center space-x-2">
                    <span class="font-medium text-gray-700">
                        Chào, <span th:text="${session.username}">Tên người dùng</span>
                    </span>
                    <a th:href="@{/account/logout}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                        Đăng xuất
                    </a>
                </div>
                <a th:unless="${session.username}" th:href="@{/account/login}" class="hidden sm:block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                    Đăng nhập
                </a>
                <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-blue-600">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
        <a th:href="@{/user/category/getAll}" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Trang Chủ</a>
        <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Sản Phẩm</a>
        <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Khuyến Mãi</a>
        <a href="#" class="block px-4 py-3 text-gray-600 hover:bg-gray-100 hover:text-blue-600">Liên Hệ</a>
        <div th:if="${session.username}" class="flex items-center justify-between p-4 border-t">
            <span class="font-medium text-gray-700">
                Chào, <span th:text="${session.username}">Tên người dùng</span>
            </span>
            <a th:href="@{/account/logout}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">
                Đăng xuất
            </a>
        </div>
        <a th:unless="${session.username}" th:href="@{/account/login}" class="block p-4 text-center bg-blue-600 text-white hover:bg-blue-700 transition duration-300">
            Đăng nhập
        </a>
    </div>
</header>

<!-- Main Content -->
<main class="py-12">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Giỏ hàng của bạn</h1>

        <!-- Check if cart is not null and not empty -->
        <div th:if="${cartDto != null and not #lists.isEmpty(cartDto.cartItemDTOS)}" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cart Items List -->
            <div id="cart-items-container" class="lg:col-span-2 space-y-4">
                <div th:each="item : ${cartDto.cartItemDTOS}" th:data-product-id="${item.productId}" class="flex items-center bg-white rounded-lg shadow-md p-6 space-x-4 cart-item">
                    <!-- Product Details -->
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2" th:text="${item.productName}">Tên sản phẩm</h3>
                        <!-- Add an ID for easy JavaScript access -->
                        <p class="text-blue-600 font-bold text-xl mb-3 sub-total" th:text="${#numbers.formatDecimal(item.subTotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                    </div>

                    <!-- Quantity Controls -->
                    <div class="flex items-center space-x-3">
                        <!-- Decrease Button -->
                        <button onclick="updateQuantity(this, -1)"
                                th:data-product-id="${item.productId}"
                                th:data-user-id="${session.userid}"
                                th:data-current-quantity="${item.quantity}"
                                class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition-colors duration-200">
                            <i class="fas fa-minus text-gray-600 text-sm"></i>
                        </button>

                        <!-- Quantity Display -->
                        <!-- Add an ID for easy JavaScript access -->
                        <span class="font-semibold text-lg min-w-[2rem] text-center product-quantity" th:text="${item.quantity}">1</span>

                        <!-- Increase Button -->
                        <button onclick="updateQuantity(this, 1)"
                                th:data-product-id="${item.productId}"
                                th:data-user-id="${session.userid}"
                                th:data-current-quantity="${item.quantity}"
                                class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition-colors duration-200">
                            <i class="fas fa-plus text-gray-600 text-sm"></i>
                        </button>
                    </div>

                    <!-- Delete Button -->
                    <div class="flex items-center">
                        <button onclick="deleteItem(this)"
                                th:data-product-id="${item.productId}"
                                th:data-user-id="${session.userid}"
                                class="text-gray-500 hover:text-red-600 transition-colors duration-200 p-2">
                            <i class="fas fa-trash fa-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="bg-white rounded-lg shadow-md p-6 h-fit">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Tổng tiền</h2>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Tổng phụ:</span>
                    <span id="sub-total-summary" class="font-semibold text-gray-800" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                </div>
                <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-4">
                    <span class="text-gray-600">Phí vận chuyển:</span>
                    <span class="font-semibold text-gray-800">Miễn phí</span>
                </div>
                <div class="flex justify-between items-center text-xl font-bold text-gray-800">
                    <span>Tổng cộng:</span>
                    <span id="grand-total-summary" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                </div>
                <button class="w-full mt-6 py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-credit-card mr-2"></i>Thanh toán
                </button>
            </div>
        </div>

        <!-- Empty Cart Message -->
        <div th:unless="${cartDto != null and not #lists.isEmpty(cartDto.cartItemDTOS)}" id="empty-cart-message" class="text-center py-16 bg-white rounded-lg shadow-md">
            <i class="fas fa-shopping-cart fa-5x text-gray-300 mb-4"></i>
            <p class="text-gray-600 text-lg mb-4">Giỏ hàng của bạn đang trống!</p>
            <a href="/" class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i> Tiếp tục mua sắm
            </a>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-gray-800 text-white mt-16">
    <div class="container mx-auto px-4 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div>
                <h3 class="text-lg font-semibold mb-4">Gia Dụng Pro</h3>
                <p class="text-gray-400">Chuyên cung cấp các sản phẩm gia dụng thông minh, chất lượng cao.</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-4">Liên kết nhanh</h3>
                <ul class="space-y-2">
                    <li><a href="#" class="text-gray-400 hover:text-white">Về chúng tôi</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Sản phẩm</a></li>
                    <li><a href="#" class="text-gray-400 hover:text-white">Chính sách</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-4">Liên hệ</h3>
                <ul class="space-y-2 text-gray-400">
                    <li class="flex items-start"><i class="fas fa-map-marker-alt mt-1 mr-3"></i>123 Đường ABC, Quận 1, TP.HCM</li>
                    <li class="flex items-center"><i class="fas fa-phone-alt mr-3"></i>(028) 3812 3456</li>
                    <li class="flex items-center"><i class="fas fa-envelope mr-3"></i>contact@giadungpro.vn</li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-4">Đăng ký nhận tin</h3>
                <p class="text-gray-400 mb-4">Nhận thông tin về sản phẩm mới và khuyến mãi.</p>
                <form class="flex">
                    <input type="email" placeholder="Email của bạn" class="w-full rounded-l-lg px-4 py-2 text-gray-800 focus:outline-none">
                    <button class="bg-blue-600 px-4 rounded-r-lg hover:bg-blue-700"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
        <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-500 text-sm">
            &copy; 2024 Gia Dụng Pro. All Rights Reserved.
        </div>
    </div>
</footer>

<script>
    // Mobile menu toggle
    document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
        document.getElementById('mobile-menu')?.classList.toggle('hidden');
    });

    /**
     * Định dạng số thành chuỗi có dấu phân cách
     * @param {number} num - Số cần định dạng
     * @returns {string} - Chuỗi đã được định dạng
     */
    function formatCurrency(num) {
        if (num == null) return '0 ₫';
        return num.toLocaleString('vi-VN') + ' ₫';
    }

    /**
     * Cập nhật số lượng sản phẩm trong giỏ hàng và UI.
     * @param {HTMLElement} button - Nút được nhấn (+ hoặc -).
     * @param {number} change - Thay đổi số lượng (-1 hoặc 1).
     */
    async function updateQuantity(button, change) {
        const cartItem = button.closest('.cart-item');
        const quantitySpan = cartItem.querySelector('.product-quantity');
        const subTotalElement = cartItem.querySelector('.sub-total');

        const productId = button.dataset.productId;
        const userId = button.dataset.userId;

        // Lấy số lượng hiện tại trên UI
        const currentQuantity = parseInt(quantitySpan.textContent);
        const newQuantity = currentQuantity + change;

        if (newQuantity < 1) {
            return; // Không cho nhỏ hơn 1
        }

        console.log('Sending request with delta change:', change);

        // chọn endpoint
        let apiUrl = '';
        if (change > 0) {
            apiUrl = '/api/cart/add';
        } else {
            apiUrl = '/api/cart/remove';
        }

        // gửi delta (+1 hoặc -1) thay vì số mới
        const cartRequest = {
            userId: parseInt(userId),
            productId: parseInt(productId),
            quantity: change,   // ✅ chỉ gửi delta
            subTotal: 0
        };

        try {
            quantitySpan.textContent = '...';

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cartRequest)
            });

            const result = await response.json();
            console.log('Server response:', result);

            if (response.ok) {
                // cập nhật giao diện
                const finalClientQuantity = currentQuantity + change;
                quantitySpan.textContent = finalClientQuantity;

                if (result.data && result.data.totalAmount) {
                    document.getElementById('sub-total-summary').textContent = formatCurrency(result.data.totalAmount);
                    document.getElementById('grand-total-summary').textContent = formatCurrency(result.data.totalAmount);
                }
            } else {
                quantitySpan.textContent = currentQuantity; // rollback
                console.error('Có lỗi khi cập nhật:', result.message);
            }
        } catch (error) {
            quantitySpan.textContent = currentQuantity; // rollback
            console.error('Lỗi:', error);
        }
    }


    /**
     * Xóa sản phẩm khỏi giỏ hàng.
     * @param {HTMLElement} button - Nút xóa.
     */
    async function deleteItem(button) {
        const cartItem = button.closest('.cart-item');
        const productId = button.dataset.productId;
        const userId = button.dataset.userId;

        // Thay thế confirm() bằng một modal UI tùy chỉnh
        if (!window.confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) {
            return;
        }

        const cartRequest = {
            userId: parseInt(userId),
            productId: parseInt(productId),
            quantity: 0,
            subTotal: 0
        };

        try {
            const response = await fetch('/api/cart/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cartRequest)
            });

            const result = await response.json();

            if (response.ok) {
                // Xóa phần tử sản phẩm khỏi DOM
                cartItem.remove();

                // Cập nhật lại tổng tiền giỏ hàng
                document.getElementById('sub-total-summary').textContent = formatCurrency(result.totalAmount);
                document.getElementById('grand-total-summary').textContent = formatCurrency(result.totalAmount);

                // Nếu giỏ hàng trống, hiển thị thông báo
                const itemsContainer = document.getElementById('cart-items-container');
                if (itemsContainer.children.length === 0) {
                    const emptyMessage = document.getElementById('empty-cart-message');
                    if (emptyMessage) {
                        emptyMessage.style.display = 'block';
                    }
                }
            } else {
                console.error('Error deleting item:', result.message);
                console.error('Có lỗi xảy ra khi xóa sản phẩm: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            console.error('Có lỗi xảy ra khi xóa sản phẩm');
        }
    }
</script>

</body>
</html>
